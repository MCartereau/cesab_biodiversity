---
title: "Birds and trees ! Yippees !"
author: "The Awesome Team"
date: today
abstract: |
  Biodiversity facets of birds and trees across the Euro-Mediterranean Basin.
format:
  html:
    theme: minty
    code-fold: true
    code-summary: "Show the code"
    mermaid: 
      theme: forest
toc: true
toc_float: 
  collapsed: true

---

```{r}
#| include: FALSE

library(kableExtra)
devtools::load_all()

```

## Introduction

This project aims to map biodiversity facets (taxonomic, functional and phylogenetic) for both breeding birds and trees across the Euro-Mediterranean Basin.

## The workflow

Here is a general overview of the functions, the data and the inter-connected links involved in the workflow. 

```{r}
#| echo: FALSE
#| output: asis

library(targets)
cat(c("```{mermaid}", targets::tar_mermaid(targets_only = TRUE, exclude = "index"), "```"), sep = "\n")
```

### Loading the data

First, let's load the data! 

```{r}
#| label: 'Occurence data'
#| echo: TRUE
#| include: TRUE

occ <- targets::tar_read(load_occ)

head(occ)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 

```

```{r}
#| label: 'Trait data'
#| echo: TRUE
#| include: TRUE


traits <- targets::tar_read(load_traits)

head(traits)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 

```

```{r}
#| label: 'Phylogenetic data'
#| echo: TRUE
#| include: TRUE


phylo <- targets::tar_read(load_phylogeny)

plot(phylo) 

```

```{r}
#| label: 'Spatial grid data'
#| echo: TRUE
#| include: TRUE


spat <- targets::tar_read(load_spat)

head(spat)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 

```

### Format data

Now, we shall select the occurrences data that we need (resolution = 50km, region = whole Euro-Mediterranean Basin).

```{r}
#| label: 'Select occurences'
#| echo: TRUE
#| include: TRUE


selected_occ <- targets::tar_read(select_occ)

head(selected_occ)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 

```

To compute the functional, phylogenetic and taxonomic richness metric, we need species-sites matrices specific to the species choses (e.g. Birds, Trees)

```{r}
#| label: 'Example of format species-site matrix for Birds functional richness'
#| echo: TRUE
#| include: TRUE


mat <- targets::tar_read(format_sp_animal_func_site)

head(mat)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 

```

Also, we need to select relevant traits for the species

```{r}
#| label: 'Functional trait slection for Birds'
#| echo: TRUE
#| include: TRUE


selected_traits <- targets::tar_read(select_animal_traits)

head(selected_traits)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 
```

### Compute diversity indices

First, let's compute species richness!

```{r}
#| label: 'Species richness for birds and trees'
#| echo: TRUE
#| include: TRUE


sp_rich <- targets::tar_read(comp_sp_rich)

head(sp_rich)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 
```

Then, let's compute Faith's phylogenetic diversity for the Birds ! 

```{r}
#| label: 'Phylogenetic richness for birds'
#| echo: TRUE
#| include: TRUE


phylo_rich <- targets::tar_read(comp_phylo_animal_rich)

head(phylo_rich)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 
```

Finally, let's compute functional richness (FRic metric) for the Birds!

```{r}
#| label: 'Functional richness for birds'
#| echo: TRUE
#| include: TRUE


func_rich <- targets::tar_read(comp_func_animal_rich)

head(func_rich)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 
```

### Combine the metrics

Now let's gather the diversity metrics we computed within a single data frame for both birds and trees:

```{r}
#| label: 'Combine richness indices'
#| echo: TRUE
#| include: TRUE


ind_rich <- targets::tar_read(comb_ind_rich)

head(ind_rich)|> 
  knitr::kable(booktabs = TRUE, linesep = "2pt", align = "c", row.names = FALSE) |> 
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = T) |> 
  kable_styling(font_size = 14, position = "center") |>  
  kable_styling(latex_options = "hold_position") 
```

### Visualise the results

Finally, we're ready to plot the data and visualize beautiful maps ;) 

```{r}
#| label: "Map of taxonomic, phylogenetic, and functional biodiversity of birds and trees across the Euro-Mediterranean Basin"
#| echo: TRUE
#| fig.align: 'center'
#| include: TRUE

g <- targets::tar_read(plot)
plotly::ggplotly(g)

```
